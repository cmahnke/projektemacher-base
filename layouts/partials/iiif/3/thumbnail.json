{{- $fullResImgSuffix := "/full/full/0/default.jpg" -}}
{{- $debug := partialCached "partials/functions/debug/enabled.html" . -}}
{{- $previewImg := "" -}}
{{- $previewReference := "" -}}
{{- $contextPath := "" -}}

{{- if and (ne .File nil) (ne .File.Path nil) -}}
  {{- $contextPath = path.Dir .File.Path -}}
{{- end -}}

{{- if and (isset .Params "preview") .Params.preview -}}
  {{- $previewReference = index (where .Params.resources "name" .Params.preview) 0 -}}
{{- else if isset .Params "resources" -}}
  {{- if (gt (where .Params.resources "name" "preview" | len) 0) -}}
    {{- $previewReference = index (where .Params.resources "name" "preview") 0 -}}
  {{- else if (gt (where .Params.resources "name" "cover" | len) 0) -}}
    {{- $previewReference = index (where .Params.resources "name" "cover") 0 -}}
  {{- else if (gt (where .Params.resources "name" "front" | len) 0) -}}
    {{- $previewReference = index (where .Params.resources "name" "front") 0 -}}
  {{- else if (gt (.Params.resources | len) 0) -}}
    {{- $previewReference = index .Params.resources 0 -}}
  {{- end -}}
{{- end -}}
{{- if or (eq $previewReference "") (eq $previewReference nil) -}}
  {{- errorf "[iiif/3/thumbnail.json] Couldn't resolve preview for %s from %s" $contextPath (jsonify $previewReference) -}}
{{- end -}}
{{- $previewImg = .Resources.Get $previewReference.src -}}
{{/* Check for JXL */}}
{{- if eq (string $previewImg.MediaType) "image/jxl" -}}
  {{- $previewLoc := path.Join (path.Dir $previewReference.params.iiif) $fullResImgSuffix -}}
  {{- if $debug -}}
    {{ warnf "[iiif/3/thumbnail.json] Using %s as preview, trying to load %s as JPEG substitute for %s" $previewReference.src $previewLoc .File.Path }}
  {{- end -}}
  {{- $previewImg = .Resources.Get $previewLoc -}}
{{- end -}}

{{- $thumbnail := $previewImg.Resize "300x" -}}

{{- if ne $thumbnail nil -}}
  "thumbnail": [{
    "id": "{{ $thumbnail.Permalink }}",
    "format": "image/jpeg",
    "type":"Image",
    "height": {{ $thumbnail.Height }},
    "width": {{ $thumbnail.Width }}
  }]
{{- end -}}
