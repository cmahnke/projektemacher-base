{{- $defaultBehavior := "paged" -}}
{{- $common := dict "@context" "http://iiif.io/api/presentation/3/context.json" "type" "Manifest" "id" (.OutputFormats.Get "iiif-manifest").Permalink "viewingDirection" "left-to-right" -}}

{{- if isset .Params "iiifMetadata" -}}
  {{- errorf "[single.iiii-metadata.json] .Params.iiifMetadata isn't supported anymore use .Params.iiif.metadata" -}}
{{- end -}}
{{- if isset .Params "iiifStructure" -}}
  {{- errorf "[single.iiii-metadata.json] .Params.iiifStructure isn't supported anymore use .Params.iiif.structure" -}}
{{- end -}}

{{- with .Params.iiif.behavior -}}
  {{- if reflect.IsSlice . -}}
    {{- errorf "[iiif/3/common.json] .Params.iiif.behavior is a slice, but it should be a string" -}}
  {{- end -}}
  {{- $common = $common | merge (dict "behavior" (slice .)) -}}
{{- else -}}
  {{- $common = $common | merge (dict "behavior" (slice $defaultBehavior)) -}}
{{- end -}}

{{- if .Description -}}
  {{- $summary := partial "iiif/3/manifest-summary.json" . -}}
  {{- $common = $common | merge (dict "summary" $summary) -}}
{{- end -}}

{{- $label := dict $.Site.Language.Lang (slice (printf "%s: %s" .Site.Title .Title)) -}}
{{- if hugo.IsMultilingual -}}
  {{- $translations := where .Translations ".Lang" "!=" $.Site.Language.Lang -}}
  {{- range $translations -}}
    {{- $label = $label | merge (dict .Lang (slice (printf "%s: %s" .Site.Title .Title))) -}}
  {{- end -}}
{{- end -}}

{{- $homepage := slice (dict "id" .Permalink "type" "Text" "format" "text/html" "label" $label) -}}
{{- $label := partial "iiif/3/manifest-label.json" . -}}
{{- $requiredStatement := partial "iiif/3/required-statement.json" . -}}
{{- $thumbnails := partial "iiif/3/thumbnail.json" . -}}
{{- $provider := partialCached "iiif/3/provider.json" . -}}

{{- $common = $common | merge (dict "provider" $provider) -}}
{{- $common = $common | merge (dict "homepage" $homepage) -}}
{{- $common = $common | merge (dict "label" $label) -}}
{{- $common = $common | merge (dict "requiredStatement" $requiredStatement) -}}

{{- if gt ($thumbnails | len) 0 -}}
  {{- $common = $common | merge (dict "thumbnail" $thumbnails) -}}
{{- end -}}

{{- with .Params.iiif.metadata -}}
  {{- $common = $common | merge (dict "metadata" .) -}}
{{- end -}}
{{- with .Params.iiif.structure -}}
  {{- $common = $common | merge (dict "structures" .) -}}
{{- end -}}
{{- with .Params.iiif.rights -}}
  {{- $common = $common | merge (dict "rights" .Params.iiif.rights) -}}
{{- end -}}

{{- return $common -}}
