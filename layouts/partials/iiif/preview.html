{{/* TODO:
      * Use the 'src' field istead of 'name', or at least use seperate parameters for that
      * Make JPG or JXL handling transparent
*/}}
{{- $defaultFrontName := "front" -}}
{{- $fullResImgSuffix := "/full/full/0/default.jpg" -}}
{{- $name := $defaultFrontName -}}
{{- $src := "" -}}
{{- $context := . -}}

{{- if ne (printf "%T" .) "*hugolib.pageState" -}}
  {{- $context = .context }}
  {{- if .name -}}
    {{- $name = .name -}}
    {{- if strings.Contains $name "." -}}
      {{- $src = .name -}}
      {{- $name = "" -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{/* {{ warnf "preview called with %T" . }} */}}
{{- end -}}

{{ $img := "" }}
{{ with $context }}
  {{- $resources := .Params.resources -}}
  {{- if eq $resources nil -}}
    {{- errorf "Resource section for %s either empty or non existing" .File.Path -}}
  {{- end -}}
  {{- $frontResource := "" -}}
  {{- if ne $src "" -}}
    {{- $frontResource = where $resources "src" $src -}}
  {{- else -}}
    {{- $frontResource = where $resources "name" $name -}}
  {{- end -}}
  {{- $infoJson := (index $frontResource 0).params.iiif -}}
  {{- $path := path.Dir $infoJson -}}
  {{- $previewLoc := path.Join $path $fullResImgSuffix -}}
  {{- if not (fileExists (path.Join .File.Dir $previewLoc)) -}}
    {{- errorf "%s referenced in %s doesn't exists!" $previewLoc .File.Path -}}
  {{- end -}}
  {{- $img = .Resources.GetMatch $previewLoc -}}
{{ end }}
{{- return $img -}}
