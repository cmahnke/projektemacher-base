{{- $prefix := "" -}}
{{- $name := "" -}}
{{- $context := "" -}}
{{- $isServer := hugo.IsServer -}}

{{- $iiifImageViewerJS := "js/iiif-image-viewer.js" -}}
{{- with $.Site.Params.iiif.imageViewer -}}
  {{- if ne . "" -}}
    {{- $iiifImageViewerJS = . -}}
  {{- end -}}
{{- end -}}

{{- $iiifPresentationViewerJS := "js/iiif-presentation-viewer.js" -}}
{{- with $.Site.Params.iiif.presentationViewer -}}
  {{- if ne . "" -}}
    {{- $iiifPresentationViewerJS = . -}}
  {{- end -}}
{{- end -}}

{{- if in . "context" -}}
  {{- if .context -}}
    {{ $context = .context }}
  {{- end -}}
{{- end -}}

{{- if .Page.Params.iiifcontext -}}
    {{- $prefix = .Page.Params.iiifcontext -}}
{{- else if .Page.Params.iiif.context -}}
    $prefix = .Page.Params.iiif.context -}}
{{- else if ne (.Scratch.Get "iiifPrefix") nil -}}
    {{- $prefix = .Scratch.Get "iiifPrefix" -}}
{{- else if ne $context "" -}}
    {{- if ne ($context.Scratch.Get "iiifPrefix") nil -}}
        {{- $prefix = $context.Scratch.Get "iiifPrefix" -}}
    {{- end -}}
{{- end -}}

{{- $defines := dict "process.env.NODE_ENV" `"production"` -}}

{{- if $isServer -}}
    {{ $defines = dict "process.env.NODE_ENV" `"development"` }}
{{- end -}}

{{- $minify := false -}}
{{- $iiifJs := slice -}}

{{- if (hasPrefix $prefix "http://iiif.io/api/image/") -}}
  {{- $iiifOpts := dict "targetPath" $iiifImageViewerJS "defines" $defines "minify" $minify -}}
  {{- $iiifJs = $iiifJs | append (resources.Get $iiifImageViewerJS | js.Build $iiifOpts) -}}
{{- end -}}

{{- if (hasPrefix $prefix "http://iiif.io/api/presentation/") -}}
  {{- $iiifOpts := dict "targetPath" $iiifPresentationViewerJS "defines" $defines "minify" $minify -}}
  {{- $iiifJs = $iiifJs | append (resources.Get $iiifPresentationViewerJS | js.Build $iiifOpts) -}}
{{- end -}}

{{- return $iiifJs -}}
