{{- $pages := where .Site.AllPages "Params.displayinlist" "!=" false -}}
{{- $pages = where $pages "Language.Lang" "==" .Site.Language.Lang -}}
{{- $debug := partialCached "functions/debug/enabled.html" . -}}

{{ $taxonomy := "tags" }}

{{- $pageList := slice -}}
{{- $tagList := dict -}}
{{- range $page := $pages.ByTitle -}}
  {{- $pageUrl := .RelPermalink -}}
  {{- with .OutputFormats.Get "html" -}}
    {{- $pageUrl = .RelPermalink -}}
  {{- end -}}
  {{- $tags := dict -}}
  {{- range $tag := .Params.tags -}}
  {{/* {{- range $tag := .Site.Taxonomies.tags -}} */}}
    {{- $termTitle := "" -}}
    {{- $definitionMissing := false -}}
    {{- if ne $tag "" -}}
      {{- $tagUrl := printf "%s%s" ((printf "%s/" $taxonomy) | relLangURL) ($tag | urlize) -}}
      {{/* TODO: Check if this still works if .Site.BaseURL contains a path at the end - probably not */}}
      {{- $tagPath := (urls.Parse $tagUrl).Path -}}
      {{- $sameAs := "" -}}
      {{- with $.Site.GetPage $tagPath -}}
        {{- $termTitle = .Title -}}
        {{- if .Params.wikidata -}}
          {{- if not (reflect.IsSlice .Params.wikidata) -}}
            {{- $sameAs = .Params.wikidata -}}
          {{- end -}}
        {{- end -}}
        {{- $termPage := printf "content%s/_index.md" $tagPath -}}
        {{- if not (fileExists $termPage) -}}
          {{- if eq $debug true -}}
            {{- warnf "[tag-list.json] Missing page %s for term %s" $termPage .Data.Term -}}
          {{- end -}}
          {{- $definitionMissing = true -}}
        {{- end -}}
      {{- else -}}
        {{- $definitionMissing = true -}}
        {{- if eq $debug true -}}
          {{- warnf "[tag-list.json] can't load file %s" $tagPath -}}
        {{- end -}}
      {{- end -}}

      {{- $tagTranslations := dict -}}
      {{- if hugo.IsMultilingual -}}
        {{- range $.Site.Languages -}}
          {{- $i18nTag := $tag -}}

          {{- if eq .Lang $.Sites.Default.Language.Lang -}}
            {{- $i18nTag = i18n $tag  -}}
          {{- end -}}
          {{/* See https://github.com/gohugoio/hugo/issues/7844#issuecomment-1843854396
            {{ $i18nTag := index $.Site.Data .Lang $tag }}
          */}}
          {{- if or (eq $i18nTag "") (eq $i18nTag nil) -}}
            {{- $i18nTag = $tag -}}
          {{- end -}}

          {{- $tagTranslations =  merge $tagTranslations (dict .Lang $i18nTag) -}}
        {{- end -}}

      {{- end -}}

      {{- if isset $tagList $tag -}}
        {{- $tagPages := index (index $tagList $tag) "posts" -}}
        {{- $tagPages = $tagPages | append $pageUrl -}}
        {{- $tagMeta := dict "sameAs" $sameAs "url" $tagUrl "posts" $tagPages "count" (len $tagPages) "translations" $tagTranslations "termTitle" $termTitle -}}
        {{- if $definitionMissing -}}
          {{- $tagMeta = merge $tagMeta (dict "definitionMissing" $definitionMissing) -}}
        {{- end -}}
        {{- if ne $tagUrl $tagPath -}}
          {{- $tagMeta = merge $tagMeta (dict "tagPath" $tagPath) -}}
        {{- end -}}
        {{- $tagList = merge $tagList (dict $tag $tagMeta) -}}
      {{- else -}}
        {{- $tagMeta := dict "sameAs" $sameAs "url" $tagUrl "posts" (slice $pageUrl) "count" 1 "translations" $tagTranslations -}}
        {{- if $definitionMissing -}}
          {{- $tagMeta = merge $tagMeta (dict "definitionMissing" $definitionMissing) -}}
        {{- end -}}
        {{- $tagMeta = merge $tagMeta (dict "termTitle" $termTitle) -}}
        {{- if ne $tagUrl $tagPath -}}
          {{- $tagMeta = merge $tagMeta (dict "tagPath" $tagPath) -}}
        {{- end -}}

        {{- if eq (printf "%T" $tag) "uint64" -}}
          {{- $tag = string $tag -}}
        {{- end -}}
        {{- if ne $tag nil -}}
          {{- $tagList = merge $tagList (dict $tag $tagMeta) -}}
        {{- else -}}
          {{- warnf "[taglist.json] Tag is nil for %s!" $page.RelPermalink -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $tagList | jsonify -}}
